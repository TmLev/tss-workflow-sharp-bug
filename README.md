# TanStack Start + Workflow + Sharp Bug

Repro for the following Workflow runtime error when deployed to Vercel:

```
2026-02-11 12:32:22.967 [error] Error: Could not load the "sharp" module using the linux-arm64 runtime
Possible solutions:
- Ensure optional dependencies can be installed:
    npm install --include=optional sharp
- Ensure your package manager supports multi-platform installation:
    See https://sharp.pixelplumbing.com/install#cross-platform
- Add platform-specific dependencies:
    npm install --os=linux --cpu=arm64 sharp
- Consult the installation documentation:
    See https://sharp.pixelplumbing.com/install
    at node_modules/.pnpm/sharp@0.34.5/node_modules/sharp/lib/sharp.js (/var/task/index.js:2140:13)
    at __require (/var/task/index.js:13:50)
    at node_modules/.pnpm/sharp@0.34.5/node_modules/sharp/lib/constructor.js (/var/task/index.js:2152:5)
    at __require (/var/task/index.js:13:50)
    at node_modules/.pnpm/sharp@0.34.5/node_modules/sharp/lib/index.js (/var/task/index.js:7876:17)
    at __require (/var/task/index.js:13:50)
    at Object.<anonymous> (/var/task/index.js:30348:28)
    at Module.<anonymous> (/opt/rust/bytecode.js:2:1435)
    at A.d._compile (/opt/rust/bytecode.js:2:3186)
    at Object..js (node:internal/modules/cjs/loader:1839:10)
Node.js process exited with exit status: 1. The logs above can help with debugging the issue.
```

Build logs from Vercel:

```
13:31:23.161 Running build in Washington, D.C., USA (East) â€“ iad1
13:31:23.162 Build machine configuration: 2 cores, 8 GB
13:31:23.343 Retrieving list of deployment files...
13:31:23.798 Downloading 64 deployment files...
13:31:26.210 Restored build cache from previous deployment (Ep6V9b1azecjAq1Q2khEroxhpyen)
13:31:26.773 Running "vercel build"
13:31:27.864 Vercel CLI 50.14.1
13:31:28.430 Detected `pnpm-lock.yaml` 9 which may be generated by pnpm@9.x or pnpm@10.x
13:31:28.431 Using pnpm@10.x based on project creation date
13:31:28.431 To use pnpm@9.x, manually opt in using corepack (https://vercel.com/docs/deployments/configure-a-build#corepack)
13:31:28.464 Installing dependencies...
13:31:29.260 Lockfile is up to date, resolution step is skipped
13:31:29.483 Progress: resolved 1, reused 0, downloaded 0, added 0
13:31:29.571 Packages: +46
13:31:29.572 ++++++++++++++++++++++++++++++++++++++++++++++
13:31:30.496 Progress: resolved 46, reused 0, downloaded 10, added 1
13:31:31.486 Progress: resolved 46, reused 0, downloaded 19, added 4
13:31:32.574 Progress: resolved 46, reused 0, downloaded 27, added 6
13:31:33.524 Progress: resolved 46, reused 0, downloaded 39, added 9
13:31:34.525 Progress: resolved 46, reused 0, downloaded 40, added 9
13:31:35.526 Progress: resolved 46, reused 0, downloaded 42, added 10
13:31:36.526 Progress: resolved 46, reused 0, downloaded 46, added 37
13:31:37.526 Progress: resolved 46, reused 0, downloaded 46, added 40
13:31:38.527 Progress: resolved 46, reused 0, downloaded 46, added 42
13:31:39.318 Progress: resolved 46, reused 0, downloaded 46, added 46, done
13:31:39.625
13:31:39.726 .../sharp@0.34.5/node_modules/sharp install$ node install/check.js || npm run build
13:31:40.230 .../sharp@0.34.5/node_modules/sharp install: Done
13:31:41.343 Done in 12.7s using pnpm v10.28.0
13:31:41.381 Running "pnpm run build"
13:31:41.665
13:31:41.666 > tss-workflow-sharp-bug@ build /vercel/path0
13:31:41.666 > vite build
13:31:41.666
13:31:44.346 [info] [nitro:vercel] Using `nodejs24.x` runtime.
13:31:44.347 [info] [nitro:vercel] Using `web` entry format.
13:31:44.526 [36mvite v7.3.1 [32mbuilding client environment for production...[36m[39m
13:31:44.571 transforming...
13:31:46.459 [32mâœ“[39m 155 modules transformed.
13:31:46.653 rendering chunks...
13:31:46.766 computing gzip size...
13:31:46.781 [2m.vercel/output/static/[22m[2massets/[22m[35mstyles-CM-dXxrv.css  [39m[1m[2m  7.71 kB[22m[1m[22m[2m â”‚ gzip:   2.24 kB[22m
13:31:46.782 [2m.vercel/output/static/[22m[2massets/[22m[36mindex-yVSmVVas.js    [39m[1m[2m  4.93 kB[22m[1m[22m[2m â”‚ gzip:   2.19 kB[22m
13:31:46.782 [2m.vercel/output/static/[22m[2massets/[22m[36mmain-C7-mj9Hv.js     [39m[1m[2m315.85 kB[22m[1m[22m[2m â”‚ gzip: 100.57 kB[22m
13:31:46.782 [32mâœ“ built in 2.23s[39m
13:31:46.782 [36mvite v7.3.1 [32mbuilding ssr environment for production...[36m[39m
13:31:46.790 transforming...
13:31:48.343 [32mâœ“[39m 107 modules transformed.
13:31:48.387 rendering chunks...
13:31:48.418 [2mnode_modules/.nitro/vite/services/ssr/[22m[2massets/[22m[35mstyles-CM-dXxrv.css                     [39m[1m[2m  7.71 kB[22m[1m[22m
13:31:48.418 [2mnode_modules/.nitro/vite/services/ssr/[22m[2massets/[22m[36mstart-HYkvq4Ni.js                       [39m[1m[2m  0.06 kB[22m[1m[22m
13:31:48.419 [2mnode_modules/.nitro/vite/services/ssr/[22m[2massets/[22m[36m_tanstack-start-manifest_v-BSfO0rAY.js  [39m[1m[2m  0.38 kB[22m[1m[22m
13:31:48.419 [2mnode_modules/.nitro/vite/services/ssr/[22m[2massets/[22m[36mindex-DFOcmFbN.js                       [39m[1m[2m  1.26 kB[22m[1m[22m
13:31:48.419 [2mnode_modules/.nitro/vite/services/ssr/[22m[2massets/[22m[36mrouter-hbfRRHZv.js                      [39m[1m[2m  1.62 kB[22m[1m[22m
13:31:48.419 [2mnode_modules/.nitro/vite/services/ssr/[22m[2massets/[22m[36mindex-JhwOmGp-.js                       [39m[1m[2m  1.66 kB[22m[1m[22m
13:31:48.419 [2mnode_modules/.nitro/vite/services/ssr/[22m[36mindex.js                                       [39m[1m[2m144.99 kB[22m[1m[22m
13:31:48.419 [32mâœ“ built in 1.63s[39m
13:31:48.420 [start] [nitro] Building [Nitro] (preset: `vercel`, compatibility: `2026-02-11`)
13:31:48.422 [success] [nitro] Generated public .vercel/output/static
13:31:48.422 [36mvite v7.3.1 [32mbuilding nitro environment for production...[36m[39m
13:31:48.433 transforming...
13:31:53.941 [32mâœ“[39m 500 modules transformed.
13:31:54.598 [info] Tracing dependencies:
13:31:54.599 - `undici` (6.22.0)
13:31:54.617 [success] Traced 1 dependencies (97 files) in 603ms.
13:31:54.618 [info] Ensure your production environment matches the builder OS and architecture (`linux-x64`) to avoid native module issues.
13:31:54.859 rendering chunks...
13:31:55.117 [2m.vercel/output/functions/__server.func/[22m[36m_libs/hookable.mjs                             [39m[1m[2m  0.00 kB[22m[1m[22m
13:31:55.119 [2m.vercel/output/functions/__server.func/[22m[36m_libs/unctx.mjs                                [39m[1m[2m  0.00 kB[22m[1m[22m
13:31:55.120 [2m.vercel/output/functions/__server.func/[22m[36m_libs/ufo.mjs                                  [39m[1m[2m  0.00 kB[22m[1m[22m
13:31:55.120 [2m.vercel/output/functions/__server.func/[22m[36m_libs/ohash.mjs                                [39m[1m[2m  0.00 kB[22m[1m[22m
13:31:55.120 [2m.vercel/output/functions/__server.func/[22m[36m_libs/unstorage.mjs                            [39m[1m[2m  0.00 kB[22m[1m[22m
13:31:55.120 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/_libs/@tanstack/store.mjs              [39m[1m[2m  0.00 kB[22m[1m[22m
13:31:55.120 [2m.vercel/output/functions/__server.func/[22m[36m_libs/seroval.mjs                              [39m[1m[2m  0.00 kB[22m[1m[22m
13:31:55.120 [2m.vercel/output/functions/__server.func/[22m[36m_libs/seroval-plugins.mjs                      [39m[1m[2m  0.00 kB[22m[1m[22m
13:31:55.120 [2m.vercel/output/functions/__server.func/[22m[36m_libs/use-sync-external-store.mjs              [39m[1m[2m  0.00 kB[22m[1m[22m
13:31:55.120 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/_libs/@tanstack/react-store.mjs        [39m[1m[2m  0.00 kB[22m[1m[22m
13:31:55.121 [2m.vercel/output/functions/__server.func/[22m[36m_libs/cookie-es.mjs                            [39m[1m[2m  0.00 kB[22m[1m[22m
13:31:55.121 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/_libs/@jridgewell/sourcemap-codec.mjs  [39m[1m[2m  0.00 kB[22m[1m[22m
13:31:55.121 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/_libs/@jridgewell/resolve-uri.mjs      [39m[1m[2m  0.00 kB[22m[1m[22m
13:31:55.121 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/_libs/@jridgewell/trace-mapping.mjs    [39m[1m[2m  0.00 kB[22m[1m[22m
13:31:55.121 [2m.vercel/output/functions/__server.func/[22m[36m_libs/nanoid.mjs                               [39m[1m[2m  0.00 kB[22m[1m[22m
13:31:55.121 [2m.vercel/output/functions/__server.func/[22m[36m_libs/seedrandom.mjs                           [39m[1m[2m  0.00 kB[22m[1m[22m
13:31:55.121 [2m.vercel/output/functions/__server.func/[22m[36m_libs/workflow.mjs                             [39m[1m[2m  0.00 kB[22m[1m[22m
13:31:55.121 [2m.vercel/output/functions/__server.func/[22m[36m_libs/undici.mjs                               [39m[1m[2m  0.00 kB[22m[1m[22m
13:31:55.121 [2m.vercel/output/functions/__server.func/[22m[36m_ssr/start-HYkvq4Ni.mjs                        [39m[1m[2m  0.06 kB[22m[1m[22m
13:31:55.121 [2m.vercel/output/functions/__server.func/[22m[36m_libs/tiny-warning.mjs                         [39m[1m[2m  0.07 kB[22m[1m[22m
13:31:55.121 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/core_false.mjs                         [39m[1m[2m  0.15 kB[22m[1m[22m
13:31:55.122 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/world-local_false.mjs                  [39m[1m[2m  0.17 kB[22m[1m[22m
13:31:55.122 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/world-vercel_false.mjs                 [39m[1m[2m  0.17 kB[22m[1m[22m
13:31:55.122 [2m.vercel/output/functions/__server.func/[22m[36m_libs/tiny-invariant.mjs                       [39m[1m[2m  0.18 kB[22m[1m[22m
13:31:55.122 [2m.vercel/output/functions/__server.func/[22m[36m_libs/rou3.mjs                                 [39m[1m[2m  0.21 kB[22m[1m[22m
13:31:55.122 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/_libs/@workflow/serde.mjs              [39m[1m[2m  0.23 kB[22m[1m[22m
13:31:55.122 [2m.vercel/output/functions/__server.func/[22m[36m_ssr/_tanstack-start-manifest_v-BSfO0rAY.mjs   [39m[1m[2m  0.38 kB[22m[1m[22m
13:31:55.122 [2m.vercel/output/functions/__server.func/[22m[36m_libs/has-flag.mjs                             [39m[1m[2m  0.51 kB[22m[1m[22m
13:31:55.122 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/_libs/@tanstack/history.mjs            [39m[1m[2m  1.08 kB[22m[1m[22m
13:31:55.122 [2m.vercel/output/functions/__server.func/[22m[36m_ssr/index-JhwOmGp-.mjs                        [39m[1m[2m  2.08 kB[22m[1m[22m
13:31:55.122 [2m.vercel/output/functions/__server.func/[22m[36m_ssr/router-hbfRRHZv.mjs                       [39m[1m[2m  2.15 kB[22m[1m[22m
13:31:55.122 [2m.vercel/output/functions/__server.func/[22m[36m_libs/isbot.mjs                                [39m[1m[2m  2.41 kB[22m[1m[22m
13:31:55.122 [2m.vercel/output/functions/__server.func/[22m[36m_ssr/index-DFOcmFbN.mjs                        [39m[1m[2m  2.71 kB[22m[1m[22m
13:31:55.123 [2m.vercel/output/functions/__server.func/[22m[36m_libs/ms.mjs                                   [39m[1m[2m  2.73 kB[22m[1m[22m
13:31:55.123 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/_libs/supports-color.mjs               [39m[1m[2m  3.56 kB[22m[1m[22m
13:31:55.123 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/_libs/@workflow/errors.mjs             [39m[1m[2m  3.57 kB[22m[1m[22m
13:31:55.123 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/_libs/async-sema.mjs                   [39m[1m[2m  4.76 kB[22m[1m[22m
13:31:55.123 [2m.vercel/output/functions/__server.func/[22m[36m_libs/ulid.mjs                                 [39m[1m[2m  5.39 kB[22m[1m[22m
13:31:55.123 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/_libs/@workflow/utils.mjs              [39m[1m[2m  5.95 kB[22m[1m[22m
13:31:55.123 [2m.vercel/output/functions/__server.func/[22m[36mindex.mjs                                      [39m[1m[2m  8.27 kB[22m[1m[22m
13:31:55.123 [2m.vercel/output/functions/__server.func/[22m[36m_libs/srvx.mjs                                 [39m[1m[2m  8.38 kB[22m[1m[22m
13:31:55.123 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/_libs/@workflow/world.mjs              [39m[1m[2m 10.14 kB[22m[1m[22m
13:31:55.123 [2m.vercel/output/functions/__server.func/[22m[36m_libs/h3.mjs                                   [39m[1m[2m 13.75 kB[22m[1m[22m
13:31:55.124 [2m.vercel/output/functions/__server.func/[22m[36m_libs/mixpart.mjs                              [39m[1m[2m 14.28 kB[22m[1m[22m
13:31:55.124 [2m.vercel/output/functions/__server.func/[22m[36m_libs/devalue.mjs                              [39m[1m[2m 15.25 kB[22m[1m[22m
13:31:55.124 [2m.vercel/output/functions/__server.func/[22m[36m_libs/debug.mjs                                [39m[1m[2m 15.85 kB[22m[1m[22m
13:31:55.124 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/_libs/react.mjs                        [39m[1m[2m 20.01 kB[22m[1m[22m
13:31:55.124 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/_libs/@vercel/oidc.mjs                 [39m[1m[2m 20.14 kB[22m[1m[22m
13:31:55.124 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/_libs/@workflow/world-vercel.mjs       [39m[1m[2m 32.19 kB[22m[1m[22m
13:31:55.124 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/_libs/@workflow/core.mjs               [39m[1m[2m 36.22 kB[22m[1m[22m
13:31:55.124 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/_libs/@vercel/queue.mjs                [39m[1m[2m 40.22 kB[22m[1m[22m
13:31:55.124 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/_libs/@vercel/functions.mjs            [39m[1m[2m 41.59 kB[22m[1m[22m
13:31:55.124 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/_libs/@tanstack/react-router.mjs       [39m[1m[2m 46.80 kB[22m[1m[22m
13:31:55.124 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/_libs/@workflow/world-local.mjs        [39m[1m[2m 56.45 kB[22m[1m[22m
13:31:55.125 [2m.vercel/output/functions/__server.func/[22m[36m_libs/cbor-x.mjs                               [39m[1m[2m 76.31 kB[22m[1m[22m
13:31:55.125 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/_libs/@tanstack/router-core.mjs        [39m[1m[2m133.94 kB[22m[1m[22m
13:31:55.125 [2m.vercel/output/functions/__server.func/[22m[36m_ssr/index.mjs                                 [39m[1m[2m145.33 kB[22m[1m[22m
13:31:55.125 [2m.vercel/output/functions/__server.func/[22m[36m_libs/zod.mjs                                  [39m[1m[2m395.64 kB[22m[1m[22m
13:31:55.125 [2m.vercel/output/functions/__server.func/[22m[36m_chunks/_libs/react-dom.mjs                    [39m[1m[33m509.15 kB[39m[22m
13:31:55.125 [32mâœ“ built in 6.70s[39m
13:31:55.144 Creating Vercel Build Output API steps function
13:32:02.545 Discovering workflow directives 7401ms
13:32:03.425 Created steps bundle 879ms
13:32:03.429 Creating Vercel Build Output API workflows function
13:32:03.444 Created intermediate workflow bundle 13ms
13:32:03.641 Created final workflow bundle 195ms
13:32:03.642 Creating Vercel Build Output API webhook function
13:32:03.643 Creating webhook route
13:32:03.837 Created webhook bundle 194ms
13:32:03.840 Build Output API created at /vercel/path0/.vercel/output
13:32:03.840 Steps function available at /.well-known/workflow/v1/step
13:32:03.840 Workflows function available at /.well-known/workflow/v1/flow
13:32:03.840 Webhook function available at /.well-known/workflow/v1/webhook/[token]
13:32:03.840 Creating manifest...
13:32:04.207 Created manifest with 4 steps, 1 workflow, and 0 classes 366ms
13:32:04.210 [info] Generated .vercel/output/nitro.json
13:32:04.212 [success] [nitro] You can preview this build using `npx srvx --static ../../static .vercel/output/functions/__server.func/index.mjs`
13:32:04.212 [success] [nitro] You can deploy this build using `npx vercel deploy --prebuilt`
13:32:04.451 Build Completed in /vercel/output [36s]
13:32:04.574 Deploying outputs...
13:32:09.958 Deployment completed
13:32:10.989 Creating build cache...
13:32:58.501 Created build cache: 48s
13:32:58.501 Uploading build cache [465.11 MB]
13:33:05.387 Build cache uploaded: 6.886s
```
